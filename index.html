<html>
	<head>
		<title>Learning Registry Easy Publish</title>
		<link href="css/smoothness/jquery-ui-1.10.2.custom.css" rel="stylesheet" />
		<link href="css/jquery.fileupload-ui.css" rel="stylesheet" />
		<link href="css/jquery.ui.selectmenu.css" rel="stylesheet" />
		<link href="css/easyPub-new.css" rel="stylesheet" />
		<link href="/_browserid/style.css" rel="stylesheet">
	</head>

	<body>
		<header role="banner">
			<h1 id="ez-publish-banner">EZ Publish</h1>
			<h2 id="learning-registry-banner">Learning Registry</h2>

			<nav id="main-nav" role="navigation">
				<ul>
					<li><a href="#login">Log In</a></li>
					<li><a href="http://learningregistry.org">Learning Registry</a></li>
				</ul>
			</nav>
		</header>

		<div role="main" class="page">
			This page requires javascript.
		</div>

		<footer role="contentinfo">
			&copy; 2013 Learning Registry
		</footer>

		<script type="text/javascript" src="modules.js"></script>
		<script type="text/javascript">
			var $ = require("jquery"),
				jQuery = $,
				_ = require("underscore"),
				Backbone = require("backbone");
			Backbone.$ = $;
		</script>
		<script type="text/javascript" src="js/jquery/jquery-ui-1.10.2.custom.min.js"></script>
		<script type="text/javascript" src="js/jquery/jquery.fileupload.js"></script>
		<script type="text/javascript" src="js/jquery/ui/jquery.fileupload-ui.js"></script><!-- both are needed for file upload for some reason -->
		<script type="text/javascript" src="js/lib/oauth.js"></script>
		<script type="text/javascript" src="js/datamanager-new.js"></script>
		<script type="text/javascript" src="/_browserid/include.js"></script>
		<script type="text/javascript" src="/_browserid/main.js"></script>

		<!-- used in add/edit page -->
		<script type="text/javascript" src="js/jquery/autoCombobox.js"></script>
		<script type="text/javascript" src="js/jquery/ui/jquery.ui.selectmenu.js"></script>
		<script type="text/javascript" src="js/data/standardsTree.js"></script>
		<script type="text/javascript" src="js/data/subjects.js"></script>
		<script type="text/javascript" src="js/ccss.js"></script>
		<script type="text/javascript" src="js/treeMenu.js"></script>
		<script type="text/javascript" src="js/easyPub-new.js"></script>
		<script type="text/javascript" src="js/validator.js"></script>
		<script type="text/javascript" src="js/fields.js"></script>
		<!--<script type="text/javascript" src="js/dnd.js"></script>-->

		<script type="text/javascript">
			require("lib/credentials");
		</script>

		<script>
		var hasCredentials = false;
		$(function () {
			var Router = Backbone.Router.extend({
				routes: {
					'login': 'login',
					'logout': 'logout',
					'': 'list',
					'create': 'create',
					'edit/:id': 'edit',
					'upload': 'upload',
					'settings': 'settings',
					'help': 'help'
					// not doing bulk edit
				}
			});
			var router = new Router();

			// login and logout event handlers
			$.couch.browserid.login(function (event, error, user) {
				hasCredentials = user;
			});
			$.couch.browserid.logout(function (event, error, user) {
				if (error) {
					alert('Error logging out: ' + error);
				} else {
					hasCredentials = false;
					router.navigate('#login', {trigger:true});
				}
			});

			var Credentials = Backbone.View.extend({
				el: '.page',
				render: function () {
					if (hasCredentials) {
						$('#main-nav').html(_.template($('#logged-in-nav-template').html()));
						router.navigate('', {trigger:true});
					} else {
						var template = _.template($('#credentials-template').html());
						this.$el.html(template);
						/*if (window.localStorage != undefined) {
							if (localStorage.getItem("consumer_key") &&
								localStorage.getItem("consumer_secret") &&
								localStorage.getItem("token_secret") &&
								localStorage.getItem("node_url")) {
								hasCredentials = true;
								$('#main-nav').html(_.template($('#logged-in-nav-template').html()));
								router.navigate('', {trigger:true});
							}
						} else {
							$(".page #store_cred_row").hide();
						}*/
					}
				},
				events: {
					'submit form': 'login'
				},
				login: function (event) {
					event.preventDefault();
					var form = $(event.target);
					// TODO: check form
					hasCredentials = true;
					/*if (window.localStorage != undefined) {
						if (form.find('#store_cred').get(0).checked) {
							// store credentials for next page load
							form.find('.oauth').each(function (index, el) {
								var el = $(el);
								localStorage.setItem(el.attr('id'), el.val());
							});
						} else {
							// clear stored credentials
							form.find('.oauth').each(function (index, el) {
								var el = $(el);console.log('clearing ' + el.attr('id'));
								localStorage.removeItem(el.attr('id'));
							});
						}
					}*/
					$('#main-nav').html(_.template($('#logged-in-nav-template').html()));
					router.navigate('', {trigger:true});
				}
			});
			var credentials = new Credentials();

			var Logout = Backbone.View.extend({
				el: '.page',
				render: function () {
					$.couch.browserid.logout();
				}
			});
			var logout = new Logout();

			var List = Backbone.View.extend({
				el: '.page',
				render: function () {
					if (!hasCredentials) {
						router.navigate('login', {trigger:true});
					} else {
						// TODO: get contents
						var template = _.template($('#list-template').html());
						this.$el.html(template);
					}
				}
			});
			var list = new List();

			var Create = Backbone.View.extend({
				el: '.page',
				render: function () {
					if (!hasCredentials) {
						router.navigate('login', {trigger:true});
					} else {
						var template = _.template($('#edit-template').html());
						this.$el.html(template);
						var easyPub = new EasyPublish();
					}
				}
			});
			var create = new Create();

			var Edit = Backbone.View.extend({
				el: '.page',
				render: function () {
					if (!hasCredentials) {
						router.navigate('login', {trigger:true});
					} else {
						// TODO: get contents
						var template = _.template($('#edit-template').html(), {});
						this.$el.html(template);
						var easyPub = new EasyPublish();
					}
				}
			});
			var edit = new Edit();

			var Upload = Backbone.View.extend({
				el: '.page',
				render: function () {
					if (!hasCredentials) {
						router.navigate('login', {trigger:true});
					} else {
						var template = _.template($('#upload-template').html(), {});
						this.$el.html(template);
					}
				}
			});
			var upload = new Upload();

			var Settings = Backbone.View.extend({
				el: '.page',
				render: function () {
					if (!hasCredentials) {
						router.navigate('login', {trigger:true});
					} else {
						var template = _.template($('#settings-template').html(), {});
						this.$el.html(template);
					}
				}
			});
			var settings = new Settings();

			var Help = Backbone.View.extend({
				el: '.page',
				render: function () {
					var template = _.template($('#help-template').html(), {});
					this.$el.html(template);
				}
			});
			var help = new Help();

			router.on('route:login', function () {
				credentials.render();
			});
			router.on('route:logout', function () {
				logout.render();
			});
			router.on('route:list', function () {
				list.render();
			});
			router.on('route:create', function () {
				create.render();
			});
			router.on('route:edit', function () {
				edit.render();
			});
			router.on('route:upload', function () {
				upload.render();
			});
			router.on('route:settings', function () {
				settings.render();
			});
			router.on('route:help', function () {
				help.render();
			});

			Backbone.history.start();
		});
		</script>

		<!-- templates -->
		<script type="text/template" id="logged-in-nav-template">
			<ul>
				<li><a href="#logout">Log Out</a></li>
				<li><a href="#settings">Settings</a></li>
				<li><a href="http://learningregistry.org">Learning Registry</a></li>
			</ul>
		</script>

		<script type="text/template" id="credentials-template">
			<form>
				<h1>Enter Your Credentials</h1>
				<div id="browserid">
					<div class="login">
						<img src="/_browserid/sign_in_blue.png">
					</div>
					<div class="picture"></div>
			    </div>
				<div class='fieldRow'>
					<label for="consumer_key">Consumer Key</label><br>
					<input type="text" id="consumer_key" name="consumer_key" size="50" title="Your OAuth consumer_key" class="text ui-widget-content ui-corner-all oauth"/>
				</div>
				<div class='fieldRow'>
					<label for="consumer_secret">Consumer Secret</label><br>
					<input type="text" id="consumer_secret" name="consumer_secret" size="50"  title="Your OAuth consumer_secret" class="text ui-widget-content ui-corner-all oauth"/>
				</div>
				<div class='fieldRow'>
					<label for="token_secret">Token Secret</label><br>
					<input type="text" id="token_secret" name="token_secret" size="50"  title="Your OAuth token_secret" class="text ui-widget-content ui-corner-all oauth"/>
				</div>
				<div class='fieldRow'>
					<label for="node_url">Node URL</label><br>
					<input type="text" id="node_url" name="node_url"  size="50" title="URL of the node you would like to submit to" class="text ui-widget-content ui-corner-all oauth"/>
				</div>
				<div class='fieldRow' id="store_cred_row">
					<input type="checkbox" id="store_cred" name="store_cred"  size="50" title="Store these values in your browser's local storage."/>
					<label for="store_cred">Remember me</label>
				</div>

				<button type="submit">Log in</button>
			</form>
		</script>

		<script type="text/template" id="list-template">
			<h1>Welcome ...</h1>

			<p>You have registered ....</p>

			<a href="#create" class="button">Register new item</a>
			<a href="#upload" class="button">Bulk upload in CSV</a>

			<table>
				<thead>
					<tr>
						<th>Title</th>
						<th>Link</th>
						<th>Description</th>
						<th>Status</th>
						<th></th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>...</td>
						<td><a href="...">...</a></td>
						<td>...</td>
						<td>...</td>
						<td>
							<a href="#edit/...">Edit</a>
							<button class="delete">Delete</button>
							<button class="publish">Publish</button>
							<button class="unpublish">Un-publish</button>
						</td>
					</tr>
				</tbody>
			</table>
			<!-- pagination -->
		</script>

		<script type="text/template" id="edit-template">
			<div style="width:1150">
				<div id="rightCol">
					<form>
						<p><button id="Submit">Submit Data To Learning Registry</button></p>
						<fieldset id="dropForm">
							<legend>Import Data</legend>
			                <span class="btn btn-success fileinput-button">
			                    <span>Select File...</span>
			                    <input type="file" name="files[]" id="csvFile">
			                </span>
			                <button class="round-btn" id="csvHelp"></button>
							<a href="template.csv">Download CSV Template</a>
							<p>
								<label for="dataSelect">Select a Dataset:</label>
								<br><br>
								<select name="dataSelect" id="dataSelect">
									<option value='No Data'>No Data</option>
								</select>
								<button id="removeRow" class="btn">Remove Row</button>
							</p>
							<div>
								<button id="prevData">Previous</button><button id="nextData">Next</button>
							</div>
						</fieldset>
					</form>

				</div>
				<div id="middleCol">
					<form>
						<!-- <div id="testDiv">TEST</div> -->
						<fieldset id="alignmentForm">
							<legend>Standards Alignment</legend>
							<div class="sublegend">Alignment 1</div>
							<button id="addAlignment">Add Alignment</button>
						</fieldset>
						<fieldset id="authorForm">
							<legend>Authors</legend>
							<div class="sublegend">Author 1</div>
							<button id="addAuthor">Add Author</button>
						</fieldset>
						<fieldset id="publisherForm">
							<legend>Publisher</legend>
						</fieldset>
					</form>
				</div>
				<div id="leftCol">
					<form>
						<fieldset id="mainForm">
							<legend>Resource Information</legend>
						</fieldset>
					</form>
				</div>
			</div>
			<div id="debugConsole" style="display:none;">
				<h3>Debug buttons</h3>
				<!-- <button id="DownloadJSON">Download JSON</button> -->
				<button id="TestData">Test Data</button>
				<button id="DL_CSV">DL CSV</button>
				<button id="DL_JSON">DL JSON</button>
			</div>
			<div id="csvHelpDialog" title="CSV Import Help">
				<p>If you wish to enter data more rapidly, you can submit a CSV file. First click "Download CSV Template" to get a template file. Then add rows of data to that file. Next, import the file by clicking "Select file..." or by dragging the file into the blue area above.</p>
			</div>
			<div id="storeHelpDialog" title="Local Storage Help">
				<p>If you choose this option, your credentials will be stored in your browser using <a href="http://diveintohtml5.info/storage.html">HTML5 Local Storage</a>.</p>
			</div>
			<div id="oauthErrorDialog" title="Missing OAuth credentials">
				<p>Please supply values for all OAuth fields as well as a node URL.</p>
			</div>
			<div id="resultsDialog" title="Submission Results"><iframe width="600" height="300"></iframe></div>
		</script>

		<script type="text/template" id="upload-template">
		upload template
		</script>

		<script type="text/template" id="settings-template">
		settings template
		</script>

		<script type="text/template" id="help-template">
		help template
		</script>



		<!-- make easyPub.js happy -->
		<script id="successDialogTemplate" type="text/template">
			<div id="<%= guid %>" title="Successful Post">
				<p>Your submission "<%= name %>" has been successfully posted to the Learning Registry.
					You may find it <a href="<%= serverURL %>/obtain?by_doc_ID=true&request_ID=<%= docID %>">here</a>.
				</p>
				<p>Your submission "<%= name %>" has been successfully posted to the Learning Registry.
					You may find it <a href="<%= serverURL %>/obtain?by_doc_ID=true&request_ID=<%= docID %>">here</a>.
				</p>
			</div>
		</script>
		<script id="failDialogTemplate" type="text/template">
			<div id="<%= guid %>" title="Post Attempt Failed">
				<p>Your submission "<%= name %>" failed with the following error: <%= error %>.</p>
			</div>
		</script>

		<script id="importFailDialogTemplate" type="text/template">
			<div id="<%= guid %>" title="Import Attempt Failed">
				<p>Cannot import CSV file, it is missing the following fields:</p>
				<p><%= missingFieldsList %></p>
			</div>
		</script>
		<script id="importWarningDialogTemplate" type="text/template">
			<div id="<%= guid %>" title="Import Warning">
				<p>Import will proceed but the following columns are extraneous and will be ignored:</p>
				<p><%= extraHeadersList %></p>
			</div>
		</script>
	</body>
</html>